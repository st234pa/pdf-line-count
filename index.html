<!DOCTYPE html>
<html>
  <head>
    <title>PDF Line Count</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <h1>PDF Line Count</h1>
    <label for="fileUrl">URL:</label>
    <input type="text" id="fileUrl" name="fileUrl" />
    <button onclick="processPdfFrom()">Count</button>
    <canvas id="file-canvas" hidden="true"></canvas>
    <script src="https://unpkg.com/pdfjs-dist@latest/build/pdf.min.js"></script>
    <script>
      //const exampleUrl =
      //"https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/examples/learning/helloworld.pdf";
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://unpkg.com/pdfjs-dist@latest/build/pdf.worker.js";

      const canvas = document.getElementById("file-canvas");
      const context = canvas.getContext("2d");

      function processPdfFrom() {
        const url = document.getElementById("fileUrl").value;
        const loadingTask = pdfjsLib.getDocument(url);
        loadingTask.promise
          .then(function (pdf) {
            console.log("PDF loaded");

            // Fetch the first page
            const pageNumber = 1;
            pdf.getPage(pageNumber).then((page) => {
              console.log("Page loaded");
              const viewport = page.getViewport({ scale: 1 });

              // Prepare canvas using PDF page dimensions
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              // Render PDF page into canvas context
              const renderTask = page.render({
                canvasContext: context,
                viewport: viewport,
              });
              renderTask.promise.then(() => {
                console.log("Page rendered");
                const imageData = context.getImageData(
                  0,
                  0,
                  canvas.width,
                  canvas.height
                );
                const numLines = countLines(
                  imageData.data,
                  canvas.width,
                  canvas.height
                );
                if (numLines === 1) {
                  alert("There is 1 line in this file");
                } else {
                  alert(`There are ${numLines} lines in this file`);
                }
              });
            });
          })
          .catch((error) => console.log(error));
      }
      function countLines(data, width, height) {
        let numLines = 0;
        let previousMulti = false;
        for (let y = 0; y < height; y++) {
          let isMulti = false;
          const base = width * y * 4;
          const firstR = data[base];
          const firstG = data[base + 1];
          const firstB = data[base + 2];
          const firstA = data[base + 3];

          for (let x = 1; x < width; x++) {
            const i = (width * y + x) * 4;
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            const a = data[i + 3];

            if (r !== firstR || g !== firstG || b !== firstB || a !== firstA) {
              isMulti = true;
              if (!previousMulti) {
                numLines++;
              }
              break;
            }
          }
          previousMulti = isMulti;
        }
        return numLines;
      }
    </script>
  </body>
</html>
